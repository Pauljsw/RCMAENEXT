# cfgs/custom_models/rmae_cmae_isarc_4class_pretraining_phase2.yaml
# """
# CMAE-3D Phase 2: Multi-scale Latent Feature Reconstruction Pretraining Configuration

# Phase 2 ëª©í‘œ:
# - Phase 1 Teacher-Student ê¸°ëŠ¥ ìœ ì§€ âœ…
# - Multi-scale Latent Feature Reconstruction ì¶”ê°€ ğŸ”¥
# - ì„±ëŠ¥ í–¥ìƒì„ ìœ„í•œ semantic feature learning ğŸ”¥
# """

# âœ… ê¸°ì¡´ê³¼ ë™ì¼í•œ í´ë˜ìŠ¤ëª… ì‚¬ìš© (Phase 1ê³¼ í˜¸í™˜)
CLASS_NAMES: ['dumptruck', 'excavator', 'grader', 'roller']

DATA_CONFIG:
    # âœ… ê¸°ì¡´ê³¼ ë™ì¼í•œ base config ì‚¬ìš©
    _BASE_CONFIG_: cfgs/dataset_configs/custom_dataset_isarc.yaml
    
    # âœ… Phase 1ê³¼ ë™ì¼í•œ augmentation (gt_sampling ë¹„í™œì„±í™”)
    DATA_AUGMENTOR:
        DISABLE_AUG_LIST: ['gt_sampling']  # pretrainingì—ì„œëŠ” gt_sampling ë¹„í™œì„±í™”
        AUG_CONFIG_LIST:
            - NAME: random_world_flip
              ALONG_AXIS_LIST: ['x']
            - NAME: random_world_scaling
              WORLD_SCALE_RANGE: [0.98, 1.02]  # ê¸°ì¡´ê³¼ ë™ì¼

MODEL:
    NAME: RMAECMAEDetectorPhase2  # ğŸ”¥ ìƒˆë¡œìš´ Phase 2 detector

    VFE:
        NAME: MeanVFE

    BACKBONE_3D:
        NAME: RMAECMAEBackbonePhase2  # ğŸ”¥ ìƒˆë¡œìš´ Phase 2 backbone
        
        # ===== ğŸ“„ Phase 1 ì„¤ì • ì™„ì „ ìœ ì§€ =====
        MASKED_RATIO: 0.8
        
        # Stage 1: Angular Group Selection
        NUM_ANGULAR_GROUPS: 36          # Ng = 36 groups
        ANGULAR_GROUP_SIZE: 10          # Î”Î¸ = 10 degrees (360/36)
        
        # Stage 2: 10m/30m ê¸°ì¤€ Range-Aware Masking 
        DISTANCE_THRESHOLDS: [10, 30]   # Nearâ‰¤10m, Mid 10~30m, Far>30m
        RANGE_MASK_PROBS:               # 10m/30m ê¸°ì¤€ ë§ˆìŠ¤í‚¹ í™•ë¥ 
            NEAR: 0.50      # Nearâ‰¤10m: 50% ë§ˆìŠ¤í‚¹ (ì„¸ë¶€ì‚¬í•­ ë³´ì¡´)
            MID: 0.75       # Mid 10~30m: 75% ë§ˆìŠ¤í‚¹ (í‘œì¤€)
            FAR: 0.90       # Far>30m: 90% ë§ˆìŠ¤í‚¹ (ë†’ì€ ë§ˆìŠ¤í‚¹)
        
        # ë…¼ë¬¸ êµ¬í˜„ ì˜µì…˜ (Phase 1ê³¼ ë™ì¼)
        USE_BERNOULLI_MASKING: True     # Bernoulli distribution ì‚¬ìš©
        ENABLE_2STAGE_MASKING: True     # 2-Stage masking í™œì„±í™”
        
        # ===== ğŸ”¥ Phase 1: Teacher-Student ì„¤ì • ìœ ì§€ =====
        ENABLE_TEACHER_STUDENT: True      # Teacher-Student architecture í™œì„±í™”
        TEACHER_STUDENT_MODE: 'phase2'    # Phase 2 ëª¨ë“œë¡œ ë³€ê²½
        TEACHER_BACKBONE_TYPE: 'identical'  # Teacher = Student backbone
        FEATURE_DIM: 128                    # Feature projection ì°¨ì›
        
        # ===== ğŸ”¥ğŸ”¥ Phase 2: Multi-scale Latent Feature Reconstruction ì„¤ì • =====
        ENABLE_MLFR: True                   # MLFR ê¸°ëŠ¥ í™œì„±í™”
        MLFR_WEIGHT: 1.0                    # MLFR loss ê°€ì¤‘ì¹˜ (R-MAEì™€ ë™ë“±)
        
        # MLFR ìƒì„¸ ì„¤ì •
        MLFR_CONFIG:
            ENABLE_MLFR: True
            MLFR_SCALES: ['scale_1', 'scale_2', 'scale_3', 'scale_4']  # ëª¨ë“  scale ì‚¬ìš©
            
            # Scaleë³„ loss ê°€ì¤‘ì¹˜ (CMAE-3D ë…¼ë¬¸ ê¸°ë°˜)
            MLFR_LOSS_WEIGHTS:
                scale_1: 0.5    # Early features (16 channels): ë‚®ì€ ê°€ì¤‘ì¹˜
                scale_2: 0.8    # Mid features (32 channels): ì¤‘ê°„ ê°€ì¤‘ì¹˜  
                scale_3: 1.0    # Late features (64 channels): ë†’ì€ ê°€ì¤‘ì¹˜
                scale_4: 1.2    # Final features (128 channels): ìµœê³  ê°€ì¤‘ì¹˜
        
        # ===== ğŸ”¥ğŸ”¥ Phase 2: Voxel-level Contrastive Learning ì„¤ì • =====
        ENABLE_VOXEL_CONTRASTIVE: True      # Voxel contrastive learning í™œì„±í™”
        VOXEL_CONTRASTIVE_WEIGHT: 0.6       # Contrastive loss ê°€ì¤‘ì¹˜ (CMAE-3D ë…¼ë¬¸ ê¸°ë³¸ê°’)
        
        # Voxel Contrastive ìƒì„¸ ì„¤ì •
        VOXEL_CONTRASTIVE_CONFIG:
            CONTRASTIVE_TEMPERATURE: 0.07    # InfoNCE temperature (CMAE-3D ë…¼ë¬¸ ê¸°ë³¸ê°’)
            FEATURE_DIM: 128                 # Input feature dimension
            PROJECTION_DIM: 128              # Contrastive projection dimension
            
            # Negative sampling ì„¤ì •
            MAX_NEGATIVE_SAMPLES: 4096       # ë©”ëª¨ë¦¬ íš¨ìœ¨ì„±ì„ ìœ„í•œ negative sampling
            
            # Hard negative mining ì„¤ì •
            ENABLE_HARD_NEGATIVE_MINING: True
            HARD_NEGATIVE_RATIO: 0.3         # 30% hard negatives
            
            # Coordinate matching ì„¤ì •
            COORD_TOLERANCE: 0               # ì •í™•í•œ ì¢Œí‘œ ë§¤ì¹­ (0) vs ê·¼ì‚¬ ë§¤ì¹­ (>0)
        
        # ğŸ“ Pretraining ëª¨ë“œ ì„¤ì • (Phase 1ê³¼ ë™ì¼)
        PRETRAINING: True                   # R-MAE occupancy prediction í™œì„±í™”

    # âœ… Pretraining ëª¨ë“œì—ì„œëŠ” DENSE_HEAD ì œê±° (Phase 1ê³¼ ë™ì¼)

    POST_PROCESSING:
        RECALL_THRESH_LIST: [0.3, 0.5, 0.7]
        EVAL_METRIC: kitti

# ===== ğŸš€ Phase 2 Loss ê°€ì¤‘ì¹˜ ì„¤ì • =====  
LOSS_CONFIG:
    # Phase 1 loss weights ìœ ì§€
    RMAE_WEIGHT: 1.0                    # R-MAE occupancy loss ê°€ì¤‘ì¹˜
    TEACHER_STUDENT_WEIGHT: 0.0         # Phase 2ì—ì„œë„ ì•„ì§ ë¹„í™œì„±í™” (Phase 3ì—ì„œ 0.6)
    
    # ğŸ”¥ Phase 2 ìƒˆë¡œìš´ loss weights
    MLFR_WEIGHT: 1.0                    # Multi-scale feature reconstruction loss ê°€ì¤‘ì¹˜
    VOXEL_CONTRASTIVE_WEIGHT: 0.6       # Voxel-level contrastive learning loss ê°€ì¤‘ì¹˜ (CMAE-3D ë…¼ë¬¸)
    DETECTION_WEIGHT: 0.0               # Pretrainingì—ì„œëŠ” detection ë¹„í™œì„±í™”

# ===== ğŸ“Š Phase 2 ìµœì í™” ì„¤ì • =====
OPTIMIZATION:
    # Phase 1 ìµœì í™” ì„¤ì • ì™„ì „ ìœ ì§€ (ì•ˆì •ì„±ì„ ìœ„í•´)
    BATCH_SIZE_PER_GPU: 16               # ê¸°ì¡´ê³¼ ë™ì¼
    NUM_EPOCHS: 30                       # ê¸°ì¡´ê³¼ ë™ì¼

    OPTIMIZER: adam_onecycle             # ê¸°ì¡´ê³¼ ë™ì¼
    LR: 0.001                            # ê¸°ì¡´ê³¼ ë™ì¼ (Pretrainingìš©)
    WEIGHT_DECAY: 0.01                   # ê¸°ì¡´ê³¼ ë™ì¼
    MOMENTUM: 0.9                        # ê¸°ì¡´ê³¼ ë™ì¼

    MOMS: [0.95, 0.85]                   # ê¸°ì¡´ê³¼ ë™ì¼
    PCT_START: 0.4                       # ê¸°ì¡´ê³¼ ë™ì¼
    DIV_FACTOR: 10                       # ê¸°ì¡´ê³¼ ë™ì¼
    DECAY_STEP_LIST: [20, 25]            # ê¸°ì¡´ê³¼ ë™ì¼
    LR_DECAY: 0.1                        # ê¸°ì¡´ê³¼ ë™ì¼
    LR_CLIP: 0.0000001                   # ê¸°ì¡´ê³¼ ë™ì¼

    # Warmup ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼)
    LR_WARMUP: False                     # ê¸°ì¡´ê³¼ ë™ì¼
    WARMUP_EPOCH: 1                      # ê¸°ì¡´ê³¼ ë™ì¼
    
    GRAD_NORM_CLIP: 10                   # ê¸°ì¡´ê³¼ ë™ì¼

# ===== ğŸ“ Phase 2 ì‹¤í—˜ íƒœê·¸ =====
EXPERIMENT:
    PHASE: 2
    DESCRIPTION: 'Multi-scale Latent Feature Reconstruction + Voxel-level Contrastive Learning'
    FEATURES: ['teacher_student_architecture', 'rmae_full_compatibility', 'mlfr_semantic_learning', 'voxel_contrastive_learning']
    EXPECTED_IMPROVEMENT: '+2~3 mAP improvement through semantic feature learning + spatial consistency'
    
    # Phase 2 ì§„í–‰ ìƒí™© ì¶”ì 
    PROGRESS:
        STEP_1_MLFR: 'COMPLETED'            # âœ… Multi-scale Feature Reconstruction
        STEP_2_VOXEL_CONTRASTIVE: 'COMPLETED'  # âœ… Voxel-level Contrastive Learning
        STEP_3_FRAME_CONTRASTIVE: 'PENDING'    # Frame-level Contrastive Learning
        STEP_4_INTEGRATION: 'PENDING'          # Final Integration
        
    # Step 2 ì™„ë£Œ ì„¸ë¶€ì‚¬í•­
    STEP_2_DETAILS:
        CONTRASTIVE_TYPE: 'InfoNCE'
        TEMPERATURE: 0.07
        POSITIVE_PAIRS: 'same_spatial_coordinates'
        NEGATIVE_PAIRS: 'different_spatial_coordinates'
        HARD_NEGATIVE_MINING: True